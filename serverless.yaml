service: snowroom

custom:
  staticSiteBucket: snowroom.codebravo.tech
  redirectionBucket: snowroom.johnnypovolny.com
  staticSiteHostedZoneName: codebravo.tech
  redirectionHostedZoneName: johnnypovolny.com
  aliasHostedZoneId: Z3BJ6K6RIION7M   # us-west-2
  aliasDNSName: s3-website-us-west-2.amazonaws.com

provider:
  name: aws
  region: us-west-2
  runtime: nodejs8.10
  stage: demo
  timeout: 30

resources:
  Resources:
    StaticSiteBucket:
      Type: AWS::S3::Bucket
      Properties:
        AccessControl: PublicRead
        BucketName: ${self:custom.staticSiteBucket}
        WebsiteConfiguration:
          IndexDocument: index.html
    RedirectionBucket:
      Type: AWS::S3::Bucket
      Properties:
        AccessControl: PublicRead
        BucketName: ${self:custom.redirectionBucket}
        WebsiteConfiguration:
          RedirectAllRequestsTo: 
            HostName: ${self:custom.staticSiteBucket}
            Protocol: http
    StaticSiteS3BucketPolicy:
          Type: AWS::S3::BucketPolicy
          Properties:
            Bucket:
              Ref: StaticSiteBucket
            PolicyDocument:
              Statement:
                - Sid: PublicReadGetObject
                  Effect: Allow
                  Principal: "*"
                  Action:
                  - s3:GetObject
                  Resource:
                    Fn::Join: [
                      "", [
                        "arn:aws:s3:::",
                        {
                          "Ref": "StaticSiteBucket"
                        },
                        "/*"
                      ]
                    ]
    RedirectionS3BucketPolicy:
          Type: AWS::S3::BucketPolicy
          Properties:
            Bucket:
              Ref: RedirectionBucket
            PolicyDocument:
              Statement:
                - Sid: PublicReadGetObject
                  Effect: Allow
                  Principal: "*"
                  Action:
                  - s3:GetObject
                  Resource:
                    Fn::Join: [
                      "", [
                        "arn:aws:s3:::",
                        {
                          "Ref": "RedirectionBucket"
                        },
                        "/*"
                      ]
                    ]
    DnsRecordStaticBucket:
          Type: "AWS::Route53::RecordSet"
          Properties:
            AliasTarget:
              DNSName: ${self:custom.aliasDNSName}
              HostedZoneId: ${self:custom.aliasHostedZoneId}
            HostedZoneName: ${self:custom.staticSiteHostedZoneName}.
            Name:
              Ref: StaticSiteBucket
            Type: 'A'
    DNSRecordRedirectionBucket:
          Type: "AWS::Route53::RecordSet"
          Properties:
            AliasTarget:
              DNSName: s3-website-us-west-2.amazonaws.com
              HostedZoneId: ${self:custom.aliasHostedZoneId}
            HostedZoneName: ${self:custom.redirectionHostedZoneName}.
            Name:
              Ref: RedirectionBucket
            Type: 'A'    